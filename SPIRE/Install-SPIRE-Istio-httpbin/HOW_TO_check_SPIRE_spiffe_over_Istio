

How to check whether spiffe id generated from SPIRE or Istio 
=============================================================


clu2 [295]{~}# POD=$(kubectl -n sample get pod -l app=httpbin -o jsonpath='{.items[0].metadata.name}')
clu2 [296]{~}# echo $POD
httpbin-5c4cd67c58-cqkxq


clu2 [297]{~}# kubectl -n sample exec $POD -c istio-proxy -- ls -l /run/secrets/workload-spiffe-uds/socket
lrwxrwxrwx 1 root root 16 Sep 23 21:56 /run/secrets/workload-spiffe-uds/socket -> spire-agent.sock


clu2 [298]{~}# istioctl proxy-config secret -n sample $POD
RESOURCE NAME     TYPE           STATUS     VALID CERT     SERIAL NUMBER                        NOT AFTER                NOT BEFORE
default           Cert Chain     ACTIVE     true           4755ffc2e7898866e7c083ba4546b879     2025-09-24T04:16:30Z     2025-09-24T00:16:20Z
ROOTCA                           ACTIVE     false


clu2 [299]{~}# kubectl -n sample exec $POD -c istio-proxy -- \
  curl -s http://127.0.0.1:15000/certs | grep -Eo 'spiffe://[^"]+'
spiffe://example.org
spiffe://example.org/ns/sample/sa/httpbin
spiffe://example.org
spiffe://example.org/ns/sample/sa/httpbin
spiffe://example.org
spiffe://example.org/ns/sample/sa/httpbin
...




clu2 [302]{~}# kubectl -n spire-server exec -it spire-server-0 --   /opt/spire/bin/spire-server entry show
Found 8 entries
Entry ID         : example-cluster.fc7a62d1-57a4-4a18-8f39-fabe4ed96f9a
SPIFFE ID        : spiffe://example.org/ns/istio-system/sa/istio-eastwestgateway-service-account
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:ns:istio-system
Selector         : k8s:pod-uid:259505a1-5553-4216-a01e-47bd09ba0a07
Selector         : k8s:sa:istio-eastwestgateway-service-account

Entry ID         : example-cluster.f902a612-ca4c-4cda-92ea-e7a379851687
SPIFFE ID        : spiffe://example.org/ns/istio-system/sa/istio-ingressgateway-service-account
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:ns:istio-system
Selector         : k8s:pod-uid:3814ae65-3d12-40ca-b3f0-bd68259a7231
Selector         : k8s:sa:istio-ingressgateway-service-account

Entry ID         : example-cluster.38743616-0ccd-478c-bd8a-a5bf065ad67a
SPIFFE ID        : spiffe://example.org/ns/istio-system/sa/istiod
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:1f00705b-37b2-4832-9382-a86bdeb7caf8
Hint             : default

Entry ID         : example-cluster.516ed659-1acc-4e0b-8c62-5a4c8796574d
SPIFFE ID        : spiffe://example.org/ns/metallb-system/sa/controller
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:9b70112c-8a81-44d0-ac88-618458b9542d
Hint             : default

Entry ID         : example-cluster.b253ef4a-b2bb-43c0-8e88-7d235b3d56e1
SPIFFE ID        : spiffe://example.org/ns/metallb-system/sa/speaker
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:0fa6a0d2-e1ee-4ea1-9f32-69bd4577c8f5
Hint             : default

Entry ID         : example-cluster.5a4c5497-10a7-4f02-a7b5-8974bc61328f
SPIFFE ID        : spiffe://example.org/ns/sample/sa/default
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:6065ee53-67bf-452c-8de2-139ac43ef99b
Hint             : default

Entry ID         : example-cluster.b0dc49b7-45b9-4e91-b25a-b4bf1e93d5c0
SPIFFE ID        : spiffe://example.org/ns/sample/sa/httpbin  	<------- HERE !!!
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:f04b108c-c3aa-4fcd-80fe-c3fd6aa4ad75
Hint             : default

Entry ID         : example-cluster.52a3f492-82d8-4d61-83b8-0929ee913dca
SPIFFE ID        : spiffe://example.org/ns/spire-server/sa/spire-spiffe-oidc-discovery-provider
Parent ID        : spiffe://example.org/spire/agent/k8s_psat/example-cluster/46284097-d536-4717-a2ea-db2b347d298a
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:af265137-74f3-4bd2-a2ed-43ea08a580ed
DNS name         : oidc-discovery.example.org
DNS name         : spire-spiffe-oidc-discovery-provider
DNS name         : spire-spiffe-oidc-discovery-provider.spire-server
DNS name         : spire-spiffe-oidc-discovery-provider.spire-server.svc
DNS name         : spire-spiffe-oidc-discovery-provider.spire-server.svc.cluster.local
Hint             : oidc-discovery-provider


clu2 [308]{~}# istioctl kube-inject --filename $WORKDIR/example-curl-spire.yaml | kubectl apply -f -
serviceaccount/curl created
service/curl created
deployment.apps/curl created


clu2 [309]{~}# k exec deployments/curl -- curl -sS http://httpbin.sample.svc.cluster.local/get
{
  "args": {},
  "headers": {
    "Accept": [
      "*/*"
    ],
    "Host": [
      "httpbin.sample.svc.cluster.local"
    ],
    "User-Agent": [
      "curl/8.16.0"
    ],
    "X-Envoy-Attempt-Count": [
      "1"
    ],
    "X-Forwarded-Client-Cert": [
      "By=spiffe://example.org/ns/sample/sa/httpbin;Hash=c2bf6252bdd678fc7392d184ee34bf65be25abd6bccae63fbd5b11354ecb9c76;Subject=\"O=SPIRE,C=US\";URI=spiffe://example.org/ns/default/sa/curl"
    ],
    "X-Forwarded-Proto": [
      "http"
    ],
    "X-Request-Id": [
      "0c24d073-3485-4529-80f0-5def51673088"
    ]
  },
  "method": "GET",
  "origin": "127.0.0.6:42077",
  "url": "http://httpbin.sample.svc.cluster.local/get"
}



===================
SPIRE FEDERATION
===================

1. Root bundel checking
------------------------


  clu2 [337]{~}# kubectl --context=cluster1 -n spire-server exec spire-server-0 -- /opt/spire/bin/spire-server bundle show -format pem > /tmp/bundle-clu1.pem
  clu2 [338]{~}# kubectl --context=cluster2 -n spire-server exec spire-server-0 -- /opt/spire/bin/spire-server bundle show -format pem > /tmp/bundle-clu2.pem


  $ diff -wibup /tmp/bundle-clu1.pem /tmp/bundle-clu2.pem || true

  # sha256sum /tmp/bundle-clu1.pem /tmp/bundle-clu2.pem
  e9fc2e92222886f4b3f8b7d452792748941f2f9d74c6678fb5b751ea36fbff2b  /tmp/bundle-clu1.pem
  4a69159cb62ad96c86f57749441340e6cee03d77f71a92c6e77b9a9b6a3bb8ae  /tmp/bundle-clu2.pem


--> diff: all letters MUST be the same
--> sha256sum: MUST be the same fingerprint
	
	Above result are different root bundle












